<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gulp结构化最佳实践 | 满分笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="stylesheet" href="/full-marks/katex-css/katex.min.css">
    <link rel="stylesheet" href="/full-marks/katex-css/github-markdown.min.css">
    <meta name="description" content="记录工作和学习中有用的信息">
    
    <link rel="preload" href="/full-marks/assets/css/0.styles.20efdb12.css" as="style"><link rel="preload" href="/full-marks/assets/js/app.3998b609.js" as="script"><link rel="preload" href="/full-marks/assets/js/3.013cf700.js" as="script"><link rel="preload" href="/full-marks/assets/js/26.7e860888.js" as="script"><link rel="prefetch" href="/full-marks/assets/js/10.2bb16a3b.js"><link rel="prefetch" href="/full-marks/assets/js/11.286e8feb.js"><link rel="prefetch" href="/full-marks/assets/js/12.03728183.js"><link rel="prefetch" href="/full-marks/assets/js/13.2517de93.js"><link rel="prefetch" href="/full-marks/assets/js/14.40d8bd25.js"><link rel="prefetch" href="/full-marks/assets/js/15.6f5093dd.js"><link rel="prefetch" href="/full-marks/assets/js/16.71996444.js"><link rel="prefetch" href="/full-marks/assets/js/17.75bfe93e.js"><link rel="prefetch" href="/full-marks/assets/js/18.8084d672.js"><link rel="prefetch" href="/full-marks/assets/js/19.554161ec.js"><link rel="prefetch" href="/full-marks/assets/js/20.07fa65e5.js"><link rel="prefetch" href="/full-marks/assets/js/21.0f0a1731.js"><link rel="prefetch" href="/full-marks/assets/js/22.b7f50d87.js"><link rel="prefetch" href="/full-marks/assets/js/23.2a37d78b.js"><link rel="prefetch" href="/full-marks/assets/js/24.f07a7d1e.js"><link rel="prefetch" href="/full-marks/assets/js/25.d58be403.js"><link rel="prefetch" href="/full-marks/assets/js/27.3f03b75f.js"><link rel="prefetch" href="/full-marks/assets/js/28.d713ecec.js"><link rel="prefetch" href="/full-marks/assets/js/29.a23ad567.js"><link rel="prefetch" href="/full-marks/assets/js/30.b980fc9f.js"><link rel="prefetch" href="/full-marks/assets/js/31.8ea180f9.js"><link rel="prefetch" href="/full-marks/assets/js/32.3d57e87e.js"><link rel="prefetch" href="/full-marks/assets/js/33.7f4d4ae4.js"><link rel="prefetch" href="/full-marks/assets/js/4.936ec0c8.js"><link rel="prefetch" href="/full-marks/assets/js/5.71041521.js"><link rel="prefetch" href="/full-marks/assets/js/6.fb430fbb.js"><link rel="prefetch" href="/full-marks/assets/js/7.8874b7ad.js"><link rel="prefetch" href="/full-marks/assets/js/8.11be3746.js"><link rel="prefetch" href="/full-marks/assets/js/9.649792d7.js"><link rel="prefetch" href="/full-marks/assets/js/vendors~flowchart.4f6f7a0b.js">
    <link rel="stylesheet" href="/full-marks/assets/css/0.styles.20efdb12.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/full-marks/" class="home-link router-link-active"><img src="/full-marks/icon-100.png" alt="满分笔记" class="logo"> <span class="site-name can-hide">满分笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/full-marks/md/escape-characters.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  转义字符表
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/full-marks/md/emoji.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Emoji
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://vuepress.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/full-marks/md/escape-characters.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  转义字符表
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/full-marks/md/emoji.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Emoji
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://vuepress.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vite</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>KOA</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>规范</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ESLint</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Markdown</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>工具</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/full-marks/tools/tools-list.html" class="sidebar-link">常用工具列表</a></li><li><a href="/full-marks/tools/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/full-marks/tools/n.html" class="sidebar-link">Node.js版本管理工具n</a></li><li><a href="/full-marks/tools/onrm.html" class="sidebar-link">registry管理工具onrm</a></li><li><a href="/full-marks/tools/gulp-structured.html" aria-current="page" class="active sidebar-link">Gulp结构化最佳实践</a></li><li><a href="/full-marks/tools/shelljs.html" class="sidebar-link">ShellJS</a></li><li><a href="/full-marks/tools/jest.html" class="sidebar-link">Jest</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂项</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gulp结构化最佳实践"><a href="#gulp结构化最佳实践" class="header-anchor">#</a> Gulp结构化最佳实践</h1> <blockquote><p>本文引自：<a href="https://segmentfault.com/a/1190000040609449" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000040609449<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>在 Gulp 的官方文档中，Gulp 的任务都是写在 gulpfile.js 这一个文件中的，如果任务数量不多，这并不会有什么问题，但当任务数量较多时，会造成代码可读性差，难以维护，多人协作时还会容易造成冲突。因此，更好的处理方式是把 Gulp 的代码结构化。</p> <h2 id="开始结构化"><a href="#开始结构化" class="header-anchor">#</a> 开始结构化</h2> <p><a href="https://link.segmentfault.com/?enc=B07bYevkD1OpSPYYB2IxTQ%3D%3D.0nJ0bnqCA%2F99ixx%2BtIyT%2FZkGOtHpnFyzUZlIIcx6Y%2BvBf41iq5D5w0zCBU9SQY4t" target="_blank" rel="noopener noreferrer">https://github.com/QMUI/qmui_web<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这是一个前端框架，主要由一个 SASS 方法合集与内置的工作流构成，其中工作流部分提供了一系列的任务用于处理前端流程，并且由于是可配置的框架，需要读取配置文件，因此虽然原有的 gulpfile.js 的代码并不庞大，但仍然需要进行结构化处理，本文将会详细说明如何进行结构化处理。</p> <p>主要的思路是把 gulpfile.js 中的任务分散到独立的文件中编写，然后在 gulpfile.js 中引入这些 task。因此最简便的方法是把每个 task 单独写在独立的文件中，以 task 名命名文件名，在 gulpfile.js 中把这些文件读取进去，例如：</p> <h3 id="workflow-task-clean-js"><a href="#workflow-task-clean-js" class="header-anchor">#</a> workflow/task/clean.js</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'clean'</span><span class="token punctuation">,</span> <span class="token string">'清理多余文件（清理内容在 config.json 中配置）'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// force: true 即允许 del 控制本目录以外的文件</span>
    <span class="token function">del</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>config<span class="token punctuation">.</span>cleanFileType<span class="token punctuation">,</span> <span class="token punctuation">{</span>force<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>util<span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'QMUI Clean: '</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'清理所有的 '</span> <span class="token operator">+</span> common<span class="token punctuation">.</span>config<span class="token punctuation">.</span>cleanFileType <span class="token operator">+</span> <span class="token string">' 文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="gulpfile-js"><a href="#gulpfile-js" class="header-anchor">#</a> gulpfile.js</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> gulp        <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    requireDir  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'require-dir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 遍历目录，加载 task 代码</span>
<span class="token function">requireDir</span><span class="token punctuation">(</span><span class="token string">'./workflow/task'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> recurse<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'clean'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这种方法操作起来比较简单，同时基本不需要改动原有的代码，只需对 gulpfile.js 稍作改动即可。但同时也引入了一些问题，例如，文章开头说过的，像 QMUI 这类需要读取公共配置文件的需求，这里就无法解决，各个任务中如果需要引入配置表，都需要单独引入，同时像工具方法这类内容也会重复引入，造成浪费。因此实际上，<a href="https://link.segmentfault.com/?enc=Ij5KEk2j3OzAxg0Fa1F5Lw%3D%3D.pDmfb0q4EyBe%2FHJoQ8yHFsjg5%2FpNdamIuvsib2mCRFT%2BI2kmvMqPHvMWXoq%2FwkRqn0Wx%2FxAljuOLBO1QSIJIAeWi1SBCasDodWNLoogWea4%3D" target="_blank" rel="noopener noreferrer">clean.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中也不是像上面的例子那样编写的，而是采用 module 的方式拆分任务。</p> <h2 id="module-形式的结构化"><a href="#module-形式的结构化" class="header-anchor">#</a> Module 形式的结构化</h2> <p>为了避免在子任务文件中重复引入全局的配置、插件依赖和工具方法，更好的方式就是把全局配置、工具方法以及子任务都拆分成模块，并利用 require 的方式引入模块。</p> <p>首先，可以先看一下结构化后的目录结构：</p> <div class="language-mipsasm line-numbers-mode"><pre class="language-text"><code>.
├── gulpfile.js
├── package.json
└── workflow
    ├── common.js
    ├── lib.js
    └── task
        ├── clean.js
        ├── compass.js
        ├── include.js
        ├── initProject.js
        ├── merge.js
        ├── readToolMethod.js
        ├── start.js
        ├── version.js
        └── watch.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>接下来以其中几个文件为示例：</p> <h3 id="common-js"><a href="#common-js" class="header-anchor">#</a> common.js</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 声明插件以及配置文件的依赖</span>
<span class="token keyword">var</span> plugins     <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    rename<span class="token operator">:</span> <span class="token punctuation">{</span>
                      <span class="token string">'gulp-file-include'</span><span class="token operator">:</span> <span class="token string">'include'</span><span class="token punctuation">,</span>
                      <span class="token string">'gulp-merge-link'</span><span class="token operator">:</span> <span class="token string">'merge'</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    packageInfo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    lib         <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    config      <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token comment">// 创建 common 对象</span>
<span class="token keyword">var</span> common <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

common<span class="token punctuation">.</span>plugins <span class="token operator">=</span> plugins<span class="token punctuation">;</span>
common<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
common<span class="token punctuation">.</span>packageInfo <span class="token operator">=</span> packageInfo<span class="token punctuation">;</span>
common<span class="token punctuation">.</span>lib <span class="token operator">=</span> lib<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> common<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="clean-js"><a href="#clean-js" class="header-anchor">#</a> clean.js</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">gulp<span class="token punctuation">,</span> common</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'clean'</span><span class="token punctuation">,</span> <span class="token string">'清理多余文件（清理内容在 config.json 中配置）'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// force: true 即允许 del 控制本目录以外的文件</span>
    <span class="token function">del</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>config<span class="token punctuation">.</span>cleanFileType<span class="token punctuation">,</span> <span class="token punctuation">{</span>force<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    common<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span>util<span class="token punctuation">.</span>colors<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token string">'QMUI Clean: '</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'清理所有的 '</span> <span class="token operator">+</span> common<span class="token punctuation">.</span>config<span class="token punctuation">.</span>cleanFileType <span class="token operator">+</span> <span class="token string">' 文件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="gulpfile-js-2"><a href="#gulpfile-js-2" class="header-anchor">#</a> gulpfile.js</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 * gulpfile.js QMUI Web Gulp 工作流
 */</span>
 <span class="token keyword">var</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-help'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
             description<span class="token operator">:</span> <span class="token string">'展示这个帮助菜单'</span><span class="token punctuation">,</span>
             hideDepsMessage<span class="token operator">:</span> <span class="token boolean">true</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./workflow/common.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 载入任务</span>
<span class="token keyword">var</span> taskPath <span class="token operator">=</span> <span class="token string">'workflow/task'</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>taskPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 排除非 JS 文件，如 Vim 临时文件</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./'</span> <span class="token operator">+</span> taskPath <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> _file<span class="token punctuation">)</span><span class="token punctuation">(</span>gulp<span class="token punctuation">,</span> common<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>总结如下：</p> <ul><li>公共的配置、插件依赖和工具方法使用一个 common 对象关联起来，并且封装成模块</li> <li>每个子任务封装成模块，并且可以传入 gulp 和 common 两个参数，这样公共的部分可以复用</li> <li>gulpfile.js 中遍历任务目录，对所有子任务都执行 require，所有子任务都在 gulpfile.js 中成功注册</li></ul> <p>至此，一个完整的结构化 Gulp 就处理好了，Gulp 的目录结构变得清晰很多，这时候无论是增加工具方法，增删子任务，尤其是多人协作时都会方便很多了。</p> <h2 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h2> <p>除了以上的主要思路，在实践中一些事项需要注意：</p> <ul><li>子任务是被 gulpfile.js require 进去的，因此 <code>gulp.src</code> 和 <code>gulp.dest</code> 的相对目录关系并不需要修改，依然是以 <code>gulpfile.js</code> 所在目录为基准。但子任务文件中 require 文件是以子任务文件所在目录为基准的，如上面的代码中 common.js 在引入 package.json 是需要在上层目录中进行操作 —— <code>packageInfo = require('../package.json')</code>。</li> <li>require 当前目录的模块不能省略 <code>./</code>，否则无效。</li> <li>需要有项目中依赖了多个 gulp 的插件，推荐使用 <a href="https://www.npmjs.com/package/gulp-load-plugins" target="_blank" rel="noopener noreferrer">gulp-load-plugins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 插件管理多个插件。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/full-marks/tools/onrm.html" class="prev">
        registry管理工具onrm
      </a></span> <span class="next"><a href="/full-marks/tools/shelljs.html">
        ShellJS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/full-marks/assets/js/app.3998b609.js" defer></script><script src="/full-marks/assets/js/3.013cf700.js" defer></script><script src="/full-marks/assets/js/26.7e860888.js" defer></script>
  </body>
</html>
